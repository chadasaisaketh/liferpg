{% extends "base.html" %}
{% block title %}Habits | Life RPG{% endblock %}
{% block content %}

<!-- HEADER -->
<div class="flex items-center justify-between">
  <div>
    <h1 class="text-3xl font-bold text-yellow-400">Habits</h1>
    <p class="mt-1 text-gray-400">Your daily discipline quests.</p>
  </div>

  <div class="bg-gray-800 border border-gray-700 px-4 py-2 rounded-xl text-yellow-400 font-bold">
    ‚ö° XP: <span id="xpValue">0</span>
  </div>
</div>

<!-- ADD HABIT -->
<div class="mt-6">
  <button onclick="openModal()"
    class="px-4 py-2 bg-yellow-400 text-black rounded-lg font-semibold">
    + Add Habit
  </button>
</div>

<!-- DAILY PROGRESS -->
<div class="mt-6 bg-gray-800 border border-gray-700 rounded-xl p-5">
  <div class="flex justify-between mb-2">
    <h3 class="font-semibold">Today‚Äôs Progress</h3>
    <span id="dayPercent" class="text-yellow-400 font-bold">0%</span>
  </div>

  <div class="w-full bg-gray-700 rounded-full h-3">
    <div id="dayProgressBar"
      class="bg-yellow-400 h-3 rounded-full transition-all"
      style="width:0%"></div>
  </div>
</div>

<!-- STREAKS -->
<div class="grid grid-cols-2 gap-4 mt-6">
  <div class="bg-gray-800 p-4 rounded border border-gray-700">
    üî• Daily Streak:
    <span id="dailyStreak" class="text-yellow-400 font-bold">0</span>
  </div>
  <div class="bg-gray-800 p-4 rounded border border-gray-700">
    üèÜ Weekly Streak:
    <span id="weeklyStreak" class="text-yellow-400 font-bold">0</span>
  </div>
</div>

<!-- WEEKLY PROGRESS -->
<div class="mt-8 bg-gray-800 p-5 rounded border border-gray-700">
  <h3 class="font-semibold mb-4">Weekly Progress</h3>
  <div id="weeklyBars" class="flex items-end gap-2 h-32"></div>
</div>

<!-- MONTHLY HEATMAP -->
<div class="mt-8 bg-gray-800 p-5 rounded border border-gray-700">
  <h3 class="font-semibold mb-4">Monthly Activity</h3>
  <div id="heatmap" class="grid grid-cols-7 gap-2"></div>
</div>

<!-- HABITS LIST -->
<div id="habitsList" class="mt-8 space-y-4"></div>

<!-- MODAL -->
<div id="habitModal"
  class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 w-full max-w-md">

    <div class="flex justify-between mb-4">
      <h2 class="text-yellow-400 font-bold">Add / Edit Habit</h2>
      <button onclick="closeModal()">‚úñ</button>
    </div>

    <input id="habitName" class="w-full mb-3 p-2 bg-gray-800 rounded" placeholder="Habit name">
    <input id="habitTime" type="time" class="w-full mb-3 p-2 bg-gray-800 rounded">
    <select id="habitDifficulty" class="w-full mb-3 p-2 bg-gray-800 rounded">
      <option>Easy</option>
      <option>Medium</option>
      <option>Hard</option>
    </select>

    <button onclick="saveHabit()"
      class="w-full bg-yellow-400 text-black py-2 rounded">
      Save Habit
    </button>
  </div>
</div>

<style>
.heat-day{
  width:28px;
  height:28px;
  border-radius:6px;
  background:#374151;
}
.heat-perfect{ background:#22c55e; }
.heat-ok{ background:#facc15; }
.heat-none{ background:#374151; }
</style>

<script>
let habitsCache = [];
let editingHabitId = null;

function auth(json=false){
  const t = localStorage.getItem("access_token");
  return {
    headers:{
      Authorization:`Bearer ${t}`,
      ...(json && {"Content-Type":"application/json"})
    }
  }
}

/* HABITS */
async function loadHabits(){
  const r = await fetch("/api/habits/", auth());
  habitsCache = await r.json();
  habitsList.innerHTML = "";

  habitsCache.forEach(h=>{
    habitsList.innerHTML += `
    <div class="bg-gray-800 p-4 rounded flex justify-between">
      <div>
        <div class="font-semibold">${h.name}</div>
        <small class="text-gray-400">${h.time} ¬∑ ${h.difficulty}</small>
      </div>
      <button onclick="toggleHabit(${h.id})"
        class="${h.done ? "bg-gray-600" : "bg-green-500"} px-2 rounded">
        ${h.done ? "Undo" : "Done"}
      </button>
    </div>`;
  });
}

async function toggleHabit(id){
  const r = await fetch(`/api/habits/${id}/toggle/`, {method:"POST", ...auth()});
  const d = await r.json();
  xpValue.innerText = d.xp;
  loadAll();
}

/* PROGRESS */
async function loadDailyProgress(){
  const r = await fetch("/api/habits/progress/daily/", auth());
  const d = await r.json();
  dayPercent.innerText = d.percent + "%";
  dayProgressBar.style.width = d.percent + "%";
}

async function loadWeeklyProgress(){
  const r = await fetch("/api/habits/progress/weekly/", auth());
  const d = await r.json();

  weeklyBars.innerHTML = "";
  Object.entries(d.days).forEach(([day,count])=>{
    weeklyBars.innerHTML += `
    <div class="flex-1">
      <div class="bg-yellow-400 rounded" style="height:${count*15}px"></div>
    </div>`;
  });

  dailyStreak.innerText = d.daily_streak;
  weeklyStreak.innerText = d.weekly_streak;
}

/* MONTHLY HEATMAP */
async function loadMonthlyHeatmap(){
  const r = await fetch("/api/habits/monthly/", auth());
  const data = await r.json();
  heatmap.innerHTML = "";

  Object.entries(data).forEach(([date,count])=>{
    let level = "none";
    if(count >= 5) level = "perfect";
    else if(count > 0) level = "ok";

    const cell = document.createElement("div");
    cell.className = `heat-day heat-${level}`;
    cell.title = `${date}: ${count} habits`;
    cell.onclick = ()=>loadHabitsByDate(date);

    heatmap.appendChild(cell);
  });
}

async function loadHabitsByDate(date){
  const r = await fetch(`/api/habits/by-date/?date=${date}`, auth());
  const habits = await r.json();

  habitsList.innerHTML = `<h3 class="text-yellow-400 mb-3">Habits on ${date}</h3>`;
  habits.forEach(h=>{
    habitsList.innerHTML += `
    <div class="bg-gray-800 p-4 rounded flex justify-between">
      <span>${h.name}</span>
      <span>${h.done ? "‚úÖ" : "‚ùå"}</span>
    </div>`;
  });
}

/* XP */
async function loadXP(){
  const r = await fetch("/api/xp/", auth());
  xpValue.innerText = (await r.json()).xp;
}

/* MODAL */
function openModal(){
  habitModal.classList.remove("hidden");
  habitModal.classList.add("flex");
}
function closeModal(){
  habitModal.classList.add("hidden");
  habitModal.classList.remove("flex");
}

async function saveHabit(){
  await fetch("/api/habits/", {
    method:"POST",
    ...auth(true),
    body:JSON.stringify({
      name:habitName.value,
      time:habitTime.value,
      difficulty:habitDifficulty.value.toLowerCase()
    })
  });
  closeModal();
  loadHabits();
}

/* INIT */
function loadAll(){
  loadHabits();
  loadXP();
  loadDailyProgress();
  loadWeeklyProgress();
  loadMonthlyHeatmap();
}
loadAll();
</script>

{% endblock %}
