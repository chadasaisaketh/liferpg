{% extends "base.html" %}

{% block title %}Habits | Life RPG{% endblock %}

{% block content %}

<!-- ================= HEADER ================= -->
<div class="flex items-center justify-between">
    <div>
        <h1 class="text-3xl font-bold text-yellow-400">Habits</h1>
        <p class="mt-1 text-gray-400">Your daily discipline quests.</p>
    </div>

    <!-- XP BADGE -->
    <div class="bg-gray-800 border border-gray-700 px-4 py-2 rounded-xl text-yellow-400 font-bold">
        ⚡ XP: <span id="xpValue">0</span>
    </div>
</div>

<!-- ADD HABIT -->
<div class="mt-6">
    <button onclick="openModal()"
        class="px-4 py-2 bg-yellow-400 text-black rounded-lg font-semibold hover:bg-yellow-300 transition">
        + Add Habit
    </button>
</div>

<!-- HABITS LIST -->
<div id="habitsList" class="mt-8 space-y-4"></div>

<!-- XP FLOATING CONTAINER -->
<div id="xpAnimationContainer" class="fixed inset-0 pointer-events-none z-50"></div>

<!-- ================= MODAL ================= -->
<div id="habitModal"
    class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="bg-gray-900 border border-gray-700 rounded-2xl w-full max-w-md p-6">

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-yellow-400">Add / Edit Habit</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white text-xl">✖</button>
        </div>

        <form class="space-y-4">
            <div>
                <label class="block text-sm text-gray-300 mb-1">Habit Name</label>
                <input id="habitName" type="text"
                    class="w-full px-4 py-3 rounded-xl bg-gray-800 text-white border border-gray-700">
            </div>

            <div>
                <label class="block text-sm text-gray-300 mb-1">Time</label>
                <input id="habitTime" type="time"
                    class="w-full px-4 py-3 rounded-xl bg-gray-800 text-white border border-gray-700">
            </div>

            <div>
                <label class="block text-sm text-gray-300 mb-1">Difficulty</label>
                <select id="habitDifficulty"
                    class="w-full px-4 py-3 rounded-xl bg-gray-800 text-white border border-gray-700">
                    <option>Easy</option>
                    <option>Medium</option>
                    <option>Hard</option>
                </select>
            </div>

            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 bg-gray-700 rounded-lg">Cancel</button>
                <button type="button" onclick="saveHabit()"
                    class="px-4 py-2 bg-yellow-400 text-black rounded-lg font-semibold">
                    Save Habit
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ================= XP ANIMATION STYLE ================= -->
<style>
@keyframes xp-float {
    0% { opacity: 0; transform: translateY(20px) scale(0.8); }
    20% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-40px) scale(1.1); }
}
.xp-float {
    animation: xp-float 1.4s ease-out forwards;
}
</style>

<!-- ================= JAVASCRIPT ================= -->
<script>
let editingHabitId = null;
let habitsCache = [];

const XP_MAP = { easy: 10, medium: 20, hard: 30 };

/* ---------- XP FLOAT ---------- */
function showXPAnimation(amount) {
    const container = document.getElementById("xpAnimationContainer");
    const el = document.createElement("div");

    el.className = `xp-float fixed bottom-24 right-10 text-2xl font-extrabold ${
        amount > 0 ? "text-yellow-400" : "text-red-400"
    }`;

    el.innerText = amount > 0 ? `+${amount} XP` : `${amount} XP`;
    container.appendChild(el);

    setTimeout(() => el.remove(), 1500);
}

/* ---------- MODAL ---------- */
function openModal(habit = null) {
    habitModal.classList.remove("hidden");
    habitModal.classList.add("flex");

    if (habit) {
        editingHabitId = habit.id;
        habitName.value = habit.name;
        habitTime.value = habit.time;
        habitDifficulty.value =
            habit.difficulty.charAt(0).toUpperCase() + habit.difficulty.slice(1);
    } else {
        editingHabitId = null;
        habitName.value = "";
        habitTime.value = "";
        habitDifficulty.value = "Easy";
    }
}

function closeModal() {
    habitModal.classList.add("hidden");
    habitModal.classList.remove("flex");
}

/* ---------- SAVE ---------- */
async function saveHabit() {
    const token = localStorage.getItem("access_token");

    const payload = {
        name: habitName.value,
        time: habitTime.value,
        difficulty: habitDifficulty.value.toLowerCase()
    };

    let method = "POST";
    if (editingHabitId) {
        method = "PUT";
        payload.id = editingHabitId;
    }

    await fetch("/api/habits/", {
        method,
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(payload)
    });

    closeModal();
    loadHabits();
}

/* ---------- DONE / UNDO ---------- */
async function toggleHabit(id) {
    const token = localStorage.getItem("access_token");
    const habit = habitsCache.find(h => h.id === id);

    const res = await fetch(`/api/habits/${id}/toggle/`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
    });

    const data = await res.json();
    const xpChange = XP_MAP[habit.difficulty];

    if (data.status === "done") showXPAnimation(xpChange);
    if (data.status === "undone") showXPAnimation(-xpChange);

    xpValue.innerText = data.xp;
    loadHabits();
}

/* ---------- DELETE ---------- */
async function deleteHabit(id) {
    if (!confirm("Delete this habit permanently?")) return;

    const token = localStorage.getItem("access_token");
    await fetch("/api/habits/", {
        method: "DELETE",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ id })
    });

    loadHabits();
}

/* ---------- LOAD HABITS ---------- */
async function loadHabits() {
    const token = localStorage.getItem("access_token");
    const res = await fetch("/api/habits/", {
        headers: { "Authorization": `Bearer ${token}` }
    });

    const habits = await res.json();
    habitsCache = habits;

    habitsList.innerHTML = "";

    habits.forEach(habit => {
        const color =
            habit.difficulty === "hard" ? "text-red-400" :
            habit.difficulty === "medium" ? "text-yellow-400" :
            "text-green-400";

        const doneBtn = habit.done
            ? `<button onclick="toggleHabit(${habit.id})"
                class="px-3 py-1 bg-gray-600 rounded">Undo</button>`
            : `<button onclick="toggleHabit(${habit.id})"
                class="px-3 py-1 bg-green-500 rounded">Done</button>`;

        habitsList.innerHTML += `
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-5 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-semibold">${habit.name}</h3>
                <p class="text-sm text-gray-400">
                    ⏰ ${habit.time} · <span class="${color}">${habit.difficulty}</span>
                </p>
            </div>
            <div class="flex gap-2">
                ${doneBtn}
                <button onclick='openModal(${JSON.stringify(habit)})'
                    class="px-3 py-1 bg-blue-500 rounded">Edit</button>
                <button onclick="deleteHabit(${habit.id})"
                    class="px-3 py-1 bg-red-500 rounded">Delete</button>
            </div>
        </div>`;
    });
}

/* ---------- LOAD XP ---------- */
async function loadXP() {
    const token = localStorage.getItem("access_token");
    const res = await fetch("/api/xp/", {
        headers: { "Authorization": `Bearer ${token}` }
    });
    const data = await res.json();
    xpValue.innerText = data.xp;
}

/* INIT */
loadHabits();
loadXP();
</script>

{% endblock %}
